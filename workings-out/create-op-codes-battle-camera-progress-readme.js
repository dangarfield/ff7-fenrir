const fs = require('fs-extra')
const path = require('path')
const _ = require('lodash')
const OPS_FOLDER = path.join(__dirname, '..', '..', 'kujata-data', 'metadata')
const OPS_README = path.join(
  __dirname,
  '..',
  'OPS_CODES_BATTLE_CAMERA_README.md'
)
const POSITION_LOOP = path.join(
  __dirname,
  '..',
  'app',
  'battle',
  'battle-camera-op-position.js'
)
const FOCUS_LOOP = path.join(
  __dirname,
  '..',
  'app',
  'battle',
  'battle-camera-op-focus.js'
)

const getCompletedOpCodes = async filePath => {
  const completedCodes = []
  let c = fs.readFileSync(filePath).toString()
  if (c.includes('export {')) {
    c = c.split('export {')
    c = c[1].replace('}', '').split(',')
    for (let i = 0; i < c.length; i++) {
      let name = c[i].trim()
      name = name.replace('TWO_', '2')
      name = name.replace('_', '!')
      completedCodes.push(name)
    }
  }
  // console.log('completedCodes', completedCodes)
  return completedCodes
}
const generateProgress = async () => {
  const metadata = fs.readJsonSync(
    path.join(OPS_FOLDER, 'battle-camera-op-metadata.json')
  )

  // Add usage
  const usage = fs.readJsonSync(
    path.join(OPS_FOLDER, 'battle-camera-op-usage.json')
  )
  for (type of Object.keys(usage)) {
    for (const opHex of Object.keys(usage[type])) {
      const u = usage[type][opHex]
      const op = metadata[type].opCodes.find(op => op.shortName === opHex)
      // console.log('u', type, opHex, u, op)
      op.usage = u
    }
  }
  // Add completion
  const positionComplete = {
    type: 'position',
    complete: await getCompletedOpCodes(POSITION_LOOP)
  }
  const focusComplete = {
    type: 'focus',
    complete: await getCompletedOpCodes(FOCUS_LOOP)
  }
  for (items of [positionComplete, focusComplete]) {
    for (const opCode of items.complete) {
      console.log('opCode', items.type, opCode)
      const op = metadata[items.type].opCodes.find(
        op => op.shortName === opCode
      )
      if (op) {
        op.complete = true
      }
    }
  }

  // console.log('metadata', JSON.stringify(metadata, null, 2))

  let total = metadata.position.opCodes.length + metadata.focus.opCodes.length
  let totalComplete =
    positionComplete.complete.length + focusComplete.complete.length
  // console.log('total', total, totalComplete)
  return { metadata, total, totalComplete }
}
const createReadmeCell = op => {
  if (!op) {
    return ''
  } else {
    let color = 'green'
    let status = 'COMPLETE'
    if (!op.complete) {
      color = 'red'
      status = 'INCOMPLETE'
    }
    if (!op.usage) {
      op.usage = { initial: 0, main: 0, victory: 0 }
    }
    return `![Generic badge](https://img.shields.io/badge/${op.shortName}-${status}-${color}.svg)<br><code>${op.hex}</code><br>${op.description}<br><br>Usage:<br>Initial: ${op.usage.initial}<br>Main: ${op.usage.main}<br>Victory: ${op.usage.victory}`
  }
}
const renderReadme = async data => {
  const categories = data.categories
  let r = `# FF7 - Fenrir - Battle Camera Op Code Implementation Progress - ${Math.round(
    (100 * data.totalComplete) / data.total
  )}%\n`

  r = r + `\nNote: This page is autogenerated\n`
  r =
    r +
    `\nTotal progress: ${data.totalComplete} of ${
      data.totalComplete + data.total
    }\n`

  for (const categoryName of Object.keys(data.metadata)) {
    const category = data.metadata[categoryName]
    //   // console.log('category', category.name)
    r =
      r +
      `\n\n## ${category.name}\n${category.description} - Progress: ${
        category.opCodes.filter(o => o.complete).length
      } of ${category.opCodes.length}\n`
    const opChunks = _.chunk(category.opCodes, 6)
    // console.log('opChunks', opChunks.length)
    r = r + `|  |  |  |  |  |  |\n`
    r = r + `|:---:|:---:|:---:|:---:|:---:|:---:|\n`
    for (let j = 0; j < opChunks.length; j++) {
      const opChunk = opChunks[j]
      // console.log('opChunk', opChunk)
      r =
        r +
        `| ${createReadmeCell(opChunk[0])} | ${createReadmeCell(
          opChunk[1]
        )} | ${createReadmeCell(opChunk[2])} | ${createReadmeCell(
          opChunk[3]
        )} | ${createReadmeCell(opChunk[4])} | ${createReadmeCell(
          opChunk[5]
        )} |\n`
    }
  }
  await fs.writeFile(OPS_README, r)
}
const createOpCodesBattleCameraProgressReadme = async () => {
  console.log('create-op-codes-battle-camera-progress-readme: START')
  const data = await generateProgress()
  await renderReadme(data)
  console.log('create-op-codes-battle-camera-progress-readme: END')
}

module.exports = {
  createOpCodesBattleCameraProgressReadme
}
