<html>

<style>
    body {
        margin: 0;
    }

    canvas {
        width: 100%;
        height: 100%;
    }
</style>
<script type="module">
    // https://jsfiddle.net/dangarfield/Le4t7w60/418/

    import * as THREE from 'https://threejs.org/build/three.module.js'
    import {
        GUI
    } from 'https://threejs.org/examples/jsm/libs/lil-gui.module.min.js'

    let scene
    let camera
    let renderer
    let examplePlane
    let shaderPlane

    const data = {
        w: 512,
        h: 512,
        paletteSize: 3,
        fieldUrl: 'http://localhost:3001/kujata-data/data/field/flevel.lgp/md1_2.json',
        field: {},
        bgUrl: 'http://localhost:3001/kujata-data/metadata/background-layers/md1_2/md1_2.json',
        bg: {},
        pixelURL: 'http://localhost:3001/kujata-data/metadata/background-layers/md1_2/pixels/md1_2-4095-0-0-0-0-4.png',
        pixelTexture: {},
        pixels: [0, 1, 2, 0,
            1, 2, 0, 1,
            2, 0, 1, 2
        ],
        paletteURL: 'http://localhost:3001/kujata-data/metadata/background-layers/md1_2/palettes/md1_2-4.png',
        palettes: [
            [0xFF9900, 0x00FF99, 0x9900FF],
            [0x111111, 0x888888, 0xFFFFFF],
            [0xF1FAEE, 0xA8DADC, 0x457B9D]
        ],
        paletteTextures: [],
        palette: 0
    }

    function vertexShader() {
        return `
varying vec2 vUv;

void main() {
    vUv = uv;
    vec4 modelViewPosition = modelViewMatrix * vec4(position, 1.0);
    gl_Position = projectionMatrix * modelViewPosition;
}`
    }

    function fragmentShader() {
        return `
uniform int paletteSize;
uniform int useFirstPixel;
uniform sampler2D palette;
uniform sampler2D pixels;
uniform vec4[256] paletteList;
varying vec2 vUv;

vec4 getPixelColorFromPalette (vec2 vUv, sampler2D pixels, sampler2D palette, int paletteSize, vec4[256] paletteList, int useFirstPixel) {
vec4 pixelColor = texture2D(pixels, vUv);
float paletteIndex = pixelColor.x * 255.0;
// vec4 color = texture2D(palette, vec2(1.0 / float(paletteSize) * paletteIndex,0.5));
vec4 color = texture2D(palette, vec2((1.0 / float(paletteSize)) * paletteIndex + (1.0/float(paletteSize*2)),0.5));
//vec4 color = paletteList[int(paletteIndex)];
//vec2 uv2 = (vec2(paletteIndex, 0) + .5) / vec2(paletteSize, 1);
//vec4 color = texture(palette, uv2);


if (useFirstPixel == 1 && paletteIndex == 0.0) {
color.a = 0.0;
} else if(color.r == 0.0 && color.g == 0.0 && color.b == 0.0) {
color = texture2D(palette, vec2((1.0 / float(paletteSize)) * 0.0 + (1.0/float(paletteSize*2)),0.5));
}
return color;
}

void main() {

//gl_FragColor = texture2D(palette, vUv);

gl_FragColor = getPixelColorFromPalette( vUv, pixels, palette, paletteSize, paletteList, useFirstPixel );
}`
    }

    // Useful texture2d convert - https://godotshaders.com/shader/palette-shader-lospec-compatible/
    const generateShaderUniformsFromPalette = () => {
        const uniforms = {
            w: {
                value: 512
            },
            h: {
                value: 512
            },
            paletteSize: {
                // value: data.paletteSize
                value: 256
            },
            palette: {
                // value: data.paletteTexture[0]
                value: data.paletteTexture
            },
            pixels: {
                // value: pixelTexture
                value: data.pixelTexture
            }
        }

// data.pixelTexture = pixelTexture
// data.paletteTexture = paletteTexture

        return uniforms
    }
    const addShaderPlane = () => {
        const geometry = new THREE.PlaneGeometry(data.w, data.h)
        // geometry.setAttribute('pixels', new THREE.BufferAttribute(new Int8Array(data.pixels), 3))

// uniform int paletteSize;
// uniform int useFirstPixel;
// uniform sampler2D palette;
// uniform sampler2D pixels;
        const uniforms = {
        paletteSize: { value: 256},
        useFirstPixel: { value: 1},
        palette: { value: 256},
        pixels: { value: 256},
        }
        console.log('uniforms', uniforms)
        let material = new THREE.ShaderMaterial({
            uniforms: uniforms,
            fragmentShader: fragmentShader(),
            vertexShader: vertexShader()
        })
        // console.log('data.pixelTexture', data.pixelTexture)
        // material = new THREE.MeshBasicMaterial({
        //     // map: data.pixelTexture
        //     // map: data.paletteTexture
        //     map: data.paletteDataTexture
        //     // color: 'red'
        // })
        material.transparent = true
        shaderPlane = new THREE.Mesh(geometry, material)
        // shaderPlane.position.x = data.w - (data.w / 2)
        scene.add(shaderPlane)
    }
    // const setShaderPlaneColorsFromPalette = () => {
    //     shaderPlane.material.uniforms.palette = {
    //         value: data.paletteTextures[data.palette]
    //     }
    // }

    const setupScene = () => {
        scene = new THREE.Scene()
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000)
        camera.position.z = 400

        renderer = new THREE.WebGLRenderer()
        renderer.setSize(window.innerWidth, window.innerHeight)

        document.body.appendChild(renderer.domElement)
        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight
            camera.updateProjectionMatrix()
            renderer.setSize(window.innerWidth, window.innerHeight)
        }, false)
    }
    // const setupGUI = () => {
    //     const gui = new GUI()
    //     gui.add(data, 'palette', {
    //         'Palette 0': 0,
    //         'Palette 1': 1,
    //         'Palette 2': 2
    //     }).onChange(value => {
    //         setExamplePlaneColorsFromPalette()
    //         setShaderPlaneColorsFromPalette()
    //     })
    // }

    const loadPixels = async () => {
        data.pixelTexture = new THREE.TextureLoader().load(data.pixelURL)
    }

    const loadPalette = async () => {
        data.paletteTexture = new THREE.TextureLoader().load(data.paletteURL)
        const paletteInfos = data.field.palette.pages[4]

        const paletteData = new Uint8Array(4 * paletteInfos.length)
        for (let i = 0; i < paletteInfos.length; i++) {
            const paletteInfo = paletteInfos[i]
            paletteData[(i*4) + 0 ] = paletteInfo.r
            paletteData[(i*4) + 1 ] = paletteInfo.g
            paletteData[(i*4) + 2 ] = paletteInfo.b
            paletteData[(i*4) + 3 ] = paletteInfo.a
        }
        data.paletteDataTexture = new THREE.DataTexture(paletteData, paletteInfos.length, 1)

        console.log('loadPalette', paletteInfos[1], paletteData[5],paletteData[6],paletteData[7],paletteData[8], data.paletteDataTexture)
    }
    const loadData = async () => {
        const fieldRes = await fetch(data.fieldUrl)
        data.field = await fieldRes.json()
        const bgRes = await fetch(data.bgUrl)
        data.bg = await bgRes.json()
    }
    const loadLayers = async () => {
        data.layerDatas = []
        for (let i = 0; i < data.bg.layers.length; i++) {
            const layer = data.bg.layers[i]
            // console.log('layer', layer)
            const layerData = {}
            layerData.pixelUrl = layer.fileName
            layerData.pixelTexture = new THREE.TextureLoader().load(`http://localhost:3001/kujata-data/metadata/background-layers/md1_2/pixels/${layerData.pixelUrl}`)
            layerData.paletteId = layer.paletteId
            data.layerDatas[i] = layerData
        }

        data.paletteDataTextures = []
        data.paletteTextures = []
        for (let i = 0; i < data.field.palette.pages.length; i++) {
            const paletteInfos = data.field.palette.pages[i];
            const d = new Uint8Array(4 * paletteInfos.length)
            for (let i = 0; i < paletteInfos.length; i++) {
                const paletteInfo = paletteInfos[i]
                d[(i*4) + 0 ] = paletteInfo.r
                d[(i*4) + 1 ] = paletteInfo.g
                d[(i*4) + 2 ] = paletteInfo.b
                d[(i*4) + 3 ] = paletteInfo.a
            }
            data.paletteDataTextures[i] = new THREE.DataTexture(d, paletteInfos.length, 1)
            data.paletteTextures[i] = new THREE.TextureLoader().load(`http://localhost:3001/kujata-data/metadata/background-layers/md1_2/palettes/md1_2-${i}.png`)
        }

    }
    const drawLayers = () => {
        for (let i = 0; i < data.layerDatas.length; i++) {
            const layerData = data.layerDatas[i];

            const geometry = new THREE.PlaneGeometry(data.w, data.h)
            // geometry.setAttribute('pixels', new THREE.BufferAttribute(new Int8Array(data.pixels), 3))
            const uniforms = {
                paletteSize: { value: 256},
                useFirstPixel: { value: data.field.background.palette.ignoreFirstPixel[layerData.paletteId]},
                palette: { value: data.paletteDataTextures[layerData.paletteId]},
                pixels: { value: layerData.pixelTexture},
            }

            console.log('uniforms', uniforms)
            let material = new THREE.ShaderMaterial({
                uniforms: uniforms,
                fragmentShader: fragmentShader(),
                vertexShader: vertexShader()
            })
            // console.log('data.pixelTexture', data.pixelTexture)
            // material = new THREE.MeshBasicMaterial({
            // // map: data.pixelTexture
            // // map: data.paletteTexture
            // map: data.paletteDataTexture
            // // color: 'red'
            // })
            material.transparent = true
            const shaderPlane = new THREE.Mesh(geometry, material)
            // shaderPlane.position.x = data.w - (data.w / 2)
            scene.add(shaderPlane)

        }
    }
    const renderLoop = () => {
        requestAnimationFrame(renderLoop)
        renderer.render(scene, camera)
    }
    const init = async () => {
        setupScene()
        //setupGUI()
        await loadData()
        await loadPixels()
        await loadPalette()

        await loadLayers()
        await drawLayers()
        // addExamplePlane()
        console.log('post load')
        // addShaderPlane()
console.log('data', data)
        renderLoop()
    }
    init()
</script>

</html>